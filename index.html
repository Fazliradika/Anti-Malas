<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#111827" />
  <title>FokusKecil ‚Äî Anti Procrastination</title>

  <link rel="manifest" href="manifest.json" />
  <style>
    :root{
      --bg:#0b1020;
      --card:#111827;
      --card2:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --line:rgba(255,255,255,.08);
      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --accent:#60a5fa;
      --accent2:#a78bfa;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(900px 500px at 15% 10%, rgba(96,165,250,.17), transparent 60%),
                  radial-gradient(700px 400px at 75% 10%, rgba(167,139,250,.14), transparent 60%),
                  linear-gradient(180deg, #070a14, var(--bg));
      color:var(--text);
      min-height:100vh;
    }
    a{color:inherit}
    .wrap{max-width:1100px;margin:0 auto;padding:18px 14px 84px}
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(7,10,20,.9), rgba(7,10,20,.55));
      border-bottom:1px solid var(--line);
    }
    .head-inner{max-width:1100px;margin:0 auto;padding:14px}
    .row{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .brand{
      display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.2px;
    }
    .logo{
      width:36px;height:36px;border-radius:12px;
      background: conic-gradient(from 200deg, rgba(96,165,250,.9), rgba(167,139,250,.9), rgba(34,197,94,.7));
      box-shadow: 0 10px 25px rgba(96,165,250,.15);
      border:1px solid rgba(255,255,255,.14);
    }
    .subtitle{color:var(--muted);font-size:12.5px;max-width:640px}
    nav{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-left:auto;
    }
    .tab{
      border:1px solid var(--line);
      background: rgba(17,24,39,.75);
      color:var(--text);
      padding:9px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:650;
      font-size:13px;
      opacity:.9;
      transition:.15s;
      user-select:none;
    }
    .tab:hover{transform: translateY(-1px); opacity:1}
    .tab.active{
      background: linear-gradient(135deg, rgba(96,165,250,.18), rgba(167,139,250,.16));
      border-color: rgba(96,165,250,.35);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      margin-top:16px;
    }
    @media (max-width: 900px){
      .grid{grid-template-columns: 1fr}
      nav{width:100%}
    }

    .card{
      background: linear-gradient(180deg, rgba(17,24,39,.82), rgba(15,23,42,.72));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .card h2{margin:0 0 10px 0;font-size:16px}
    .muted{color:var(--muted)}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      font-size:12.5px;
    }
    .pill b{font-size:12.5px}
    .kpi{
      display:flex;gap:10px;flex-wrap:wrap;margin-top:10px
    }
    .kpi .pill{padding:9px 12px}
    .kpi .pill span{color:var(--muted)}
    .kpi .pill .num{font-weight:850}

    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:700;
      transition:.15s;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px); background: rgba(255,255,255,.08)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(96,165,250,.22), rgba(167,139,250,.18));
      border-color: rgba(96,165,250,.32);
    }
    .btn.ok{
      background: linear-gradient(135deg, rgba(34,197,94,.22), rgba(96,165,250,.12));
      border-color: rgba(34,197,94,.25);
    }
    .btn.danger{
      background: linear-gradient(135deg, rgba(239,68,68,.22), rgba(245,158,11,.12));
      border-color: rgba(239,68,68,.25);
    }
    .btn.small{padding:8px 10px;border-radius:10px;font-size:13px}
    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}

    input, textarea, select{
      width:100%;
      background: rgba(0,0,0,.25);
      border:1px solid var(--line);
      color:var(--text);
      padding:10px 12px;
      border-radius: 12px;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:78px;resize:vertical}
    .field{display:grid;gap:8px;margin-top:10px}
    .field label{font-size:12.5px;color:var(--muted);font-weight:650}

    .list{display:grid;gap:10px;margin-top:12px}
    .item{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius: 14px;
      padding:12px;
      display:grid;
      gap:8px;
    }
    .item-top{display:flex;gap:10px;align-items:flex-start;justify-content:space-between}
    .item-title{font-weight:800}
    .item-sub{font-size:12.5px;color:var(--muted)}
    .item-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .badge{
      font-size:11.5px;
      padding:5px 9px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
      background: rgba(255,255,255,.04);
      display:inline-flex;gap:6px;align-items:center;
    }
    .badge.ok{border-color: rgba(34,197,94,.25); color: rgba(34,197,94,.95)}
    .badge.warn{border-color: rgba(245,158,11,.25); color: rgba(245,158,11,.95)}
    .badge.bad{border-color: rgba(239,68,68,.25); color: rgba(239,68,68,.95)}

    .section{display:none}
    .section.active{display:block}

    .timerBox{
      display:grid; gap:10px;
    }
    .timerFace{
      border:1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      background: radial-gradient(700px 200px at 20% 10%, rgba(96,165,250,.16), transparent 70%),
                  radial-gradient(600px 220px at 80% 10%, rgba(167,139,250,.14), transparent 70%),
                  rgba(0,0,0,.18);
      padding:14px;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
    }
    .time{
      font-size:34px;
      font-weight:900;
      letter-spacing: .6px;
    }
    .timerMeta{
      display:grid;
      gap:3px;
      text-align:right;
    }
    .timerMeta .mode{font-weight:800}
    .timerMeta .desc{color:var(--muted);font-size:12.5px}

    .bars{display:grid;gap:8px;margin-top:10px}
    .barRow{display:flex;align-items:center;gap:10px}
    .barRow .day{width:70px;color:var(--muted);font-size:12px}
    .bar{
      height:10px; flex:1;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      border-radius: 999px;
      overflow:hidden;
    }
    .bar > i{
      display:block;height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(96,165,250,.75), rgba(167,139,250,.7));
    }
    .barRow .min{width:52px;text-align:right;color:var(--muted);font-size:12px}

    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.58);
      backdrop-filter: blur(8px);
      display:none;
      align-items:center; justify-content:center;
      padding:14px;
      z-index:1000;
    }
    .modalBack.show{display:flex}
    .modal{
      width:min(560px, 100%);
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(17,24,39,.95), rgba(15,23,42,.92));
      box-shadow: 0 18px 50px rgba(0,0,0,.55);
      padding:14px;
      display:grid;
      gap:10px;
    }
    .modal h3{margin:0;font-size:16px}
    .modal p{margin:0;color:var(--muted);line-height:1.4}
    .hr{height:1px;background:var(--line);margin:6px 0}
    footer{
      position:fixed; left:0; right:0; bottom:0;
      border-top:1px solid var(--line);
      background: rgba(7,10,20,.72);
      backdrop-filter: blur(10px);
      padding:10px 14px;
    }
    .foot-inner{max-width:1100px;margin:0 auto;display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .tiny{font-size:12px;color:var(--muted)}
    .kbd{
      font-size:12px;color:var(--muted);
      border:1px solid var(--line);
      padding:4px 8px;border-radius:10px;
      background: rgba(0,0,0,.18);
    }
    .toast{
      position:fixed;
      right:14px; bottom:84px;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(17,24,39,.92);
      color:var(--text);
      box-shadow: 0 18px 45px rgba(0,0,0,.5);
      display:none;
      max-width:min(360px, calc(100% - 28px));
      z-index:1200;
    }
    .toast.show{display:block}
  </style>
</head>

<body>
<header>
  <div class="head-inner">
    <div class="row">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div>FokusKecil</div>
          <div class="subtitle">Starter 2 menit ‚Ä¢ Timebox ‚Ä¢ Breakdown ‚Ä¢ If‚ÄìThen ‚Ä¢ Streak. Semua lokal & offline.</div>
        </div>
      </div>

      <nav id="nav">
        <div class="tab active" data-section="dash">Dashboard</div>
        <div class="tab" data-section="tasks">Tugas</div>
        <div class="tab" data-section="plans">If‚ÄìThen</div>
        <div class="tab" data-section="setup">Setup Fokus</div>
        <div class="tab" data-section="stats">Statistik</div>
        <div class="tab" data-section="settings">Settings</div>
      </nav>
    </div>
  </div>
</header>

<div class="wrap">
  <!-- DASHBOARD -->
  <section class="section active" id="dash">
    <div class="grid">
      <div class="card">
        <h2>Mulai sekarang (tanpa nego)</h2>
        <div class="timerBox">
          <div class="timerFace">
            <div>
              <div class="time" id="time">00:00</div>
              <div class="muted" id="timerHint">Timer siap. Pilih ‚Äú2 menit‚Äù atau ‚ÄúFokus‚Äù.</div>
            </div>
            <div class="timerMeta">
              <div class="mode" id="modeLabel">Idle</div>
              <div class="desc" id="modeDesc">‚Äî</div>
            </div>
          </div>

          <div class="btnrow">
            <button class="btn ok" id="btnStarter">Starter 2 menit</button>
            <button class="btn primary" id="btnFocus">Fokus (Pomodoro)</button>
            <button class="btn" id="btnBreak">Break</button>
            <button class="btn danger" id="btnStop">Stop</button>
          </div>

          <div class="field">
            <label>Target langkah kecil (yang valid) untuk sesi ini</label>
            <input id="sessionTarget" placeholder="Contoh: Buka file laporan + tulis 3 bullet outline" />
          </div>

          <div class="kpi">
            <div class="pill"><span>Streak</span> <span class="num" id="kpiStreak">0</span></div>
            <div class="pill"><span>Fokus hari ini</span> <span class="num" id="kpiToday">0</span></div>
            <div class="pill"><span>Target harian</span> <span class="num" id="kpiGoal">2</span></div>
            <div class="pill"><span>Total menit (7 hari)</span> <span class="num" id="kpi7d">0</span></div>
          </div>
        </div>

        <div class="hr"></div>

        <h2>Mode darurat (kalau beku)</h2>
        <div class="muted">Ini bukan motivasi. Ini ‚Äúreset‚Äù biar otak bisa mulai.</div>
        <div class="btnrow">
          <button class="btn" id="btnEmergency">Jalankan reset 5 menit</button>
          <button class="btn" id="btnQuickMIT">Set 1 target hari ini</button>
        </div>
      </div>

      <div class="card">
        <h2>3 aturan inti</h2>
        <div class="list">
          <div class="item">
            <div class="item-title">1) Mulai 2 menit</div>
            <div class="item-sub">Tujuanmu cuma memulai. Seringnya akan lanjut.</div>
            <div class="badge ok">‚úÖ anti ‚Äúnunggu mood‚Äù</div>
          </div>
          <div class="item">
            <div class="item-title">2) Timebox, bukan to-do</div>
            <div class="item-sub">Kerja 15/25 menit. Targetnya hadir, bukan selesai.</div>
            <div class="badge warn">‚è±Ô∏è anti ‚Äúkebanyakan‚Äù</div>
          </div>
          <div class="item">
            <div class="item-title">3) Langkah kecil yang valid</div>
            <div class="item-sub">Tugas besar ‚Üí langkah fisik pertama yang bisa dilakukan sekarang.</div>
            <div class="badge">üß± anti ‚Äúambigu‚Äù</div>
          </div>
        </div>

        <div class="hr"></div>

        <h2>Quick add</h2>
        <div class="field">
          <label>Judul tugas</label>
          <input id="qaTitle" placeholder="Contoh: Laporan Metpen, Latihan Back, Bug bounty recon" />
        </div>
        <div class="field">
          <label>Langkah kecil pertama (wajib)</label>
          <input id="qaTiny" placeholder="Contoh: buat outline 5 heading / buka burp + capture 1 request" />
        </div>
        <div class="btnrow">
          <button class="btn primary" id="btnAddTask">Tambah tugas</button>
        </div>

        <div class="hr"></div>

        <h2>Yang harus kamu lakukan kalau muncul malas</h2>
        <div class="muted" style="line-height:1.5">
          (a) pilih 1 tugas ‚Üí (b) tulis langkah kecil ‚Üí (c) jalankan starter 2 menit ‚Üí (d) lanjut 15/25 menit.
        </div>
      </div>
    </div>
  </section>

  <!-- TASKS -->
  <section class="section" id="tasks">
    <div class="grid">
      <div class="card">
        <h2>Daftar tugas</h2>
        <div class="muted">Setiap tugas wajib punya ‚Äúlangkah kecil‚Äù supaya otak nggak beku.</div>

        <div class="field">
          <label>Tambah tugas baru</label>
          <input id="tTitle" placeholder="Judul tugas" />
        </div>
        <div class="field">
          <label>Langkah kecil pertama (yang valid)</label>
          <input id="tTiny" placeholder="Contoh: buka file + tulis 3 bullet" />
        </div>
        <div class="field">
          <label>Catatan (opsional)</label>
          <textarea id="tNote" placeholder="Apa yang bikin kamu nunda? Apa hambatan utamanya?"></textarea>
        </div>
        <div class="btnrow">
          <button class="btn primary" id="tAdd">Tambah</button>
          <button class="btn" id="tClearDone">Hapus tugas selesai</button>
        </div>

        <div class="hr"></div>
        <div class="list" id="taskList"></div>
      </div>

      <div class="card">
        <h2>Breakdown cepat (template)</h2>
        <div class="muted">Kalau tugas besar bikin berat, pakai template ini.</div>
        <div class="list">
          <div class="item">
            <div class="item-title">Tugas: ‚ÄúKerjain laporan‚Äù</div>
            <div class="item-sub">Langkah kecil:</div>
            <div class="badge">1) buat outline 5 heading</div>
            <div class="badge">2) isi 3 bullet per heading</div>
            <div class="badge">3) tulis paragraf pertama aja</div>
          </div>
          <div class="item">
            <div class="item-title">Tugas: ‚ÄúBelajar‚Äù</div>
            <div class="item-sub">Langkah kecil:</div>
            <div class="badge">1) buka 1 sumber</div>
            <div class="badge">2) catat 5 poin</div>
            <div class="badge">3) kerjain 1 latihan</div>
          </div>
          <div class="item">
            <div class="item-title">Tugas: ‚ÄúMulai project‚Äù</div>
            <div class="item-sub">Langkah kecil:</div>
            <div class="badge">1) buat folder + README</div>
            <div class="badge">2) buat TODO 5 item</div>
            <div class="badge">3) implement 1 fitur paling kecil</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- PLANS -->
  <section class="section" id="plans">
    <div class="grid">
      <div class="card">
        <h2>If‚ÄìThen Plan (Kalau‚ÄìMaka)</h2>
        <div class="muted">Biar autopilot kamu jalan. Bukan nunggu ‚Äúsemangat‚Äù.</div>

        <div class="field">
          <label>Kalau (trigger)</label>
          <input id="pIf" placeholder="Contoh: Kalau habis mandi / Kalau buka YouTube / Kalau terasa malas mulai" />
        </div>
        <div class="field">
          <label>Maka (aksi)</label>
          <input id="pThen" placeholder="Contoh: duduk 10 menit ngerjain outline / kerja 25 menit dulu" />
        </div>
        <div class="btnrow">
          <button class="btn primary" id="pAdd">Tambah plan</button>
          <button class="btn" id="pSeed">Isi contoh plan</button>
        </div>

        <div class="hr"></div>
        <div class="list" id="planList"></div>
      </div>

      <div class="card">
        <h2>Kontrak anti distraksi (manual)</h2>
        <div class="muted">App tidak bisa ngeblok HP, tapi bisa bikin kamu patuh lewat ritual singkat.</div>

        <div class="list">
          <div class="item">
            <div class="item-title">Sebelum fokus, lakukan 3 hal:</div>
            <div class="badge">üìµ Notif off / DND</div>
            <div class="badge">üßπ Meja bersih 1 menit</div>
            <div class="badge">üß† Tulis target langkah kecil</div>
            <div class="btnrow">
              <button class="btn ok" id="btnDoContract">Saya siap fokus</button>
            </div>
          </div>
          <div class="item">
            <div class="item-title">Kalimat sakti</div>
            <div class="item-sub">‚ÄúGue cuma perlu mulai 2 menit.‚Äù ‚Ä¢ ‚ÄúTarget gue hadir 25 menit, bukan selesai.‚Äù</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- SETUP -->
  <section class="section" id="setup">
    <div class="grid">
      <div class="card">
        <h2>Checklist setup fokus (5 menit)</h2>
        <div class="muted">Kalau kamu sering ke-distract, ini senjatanya.</div>

        <div class="list" id="setupList"></div>

        <div class="btnrow">
          <button class="btn primary" id="btnSetupDone">Checklist selesai ‚Üí mulai Fokus</button>
          <button class="btn" id="btnSetupReset">Reset checklist</button>
        </div>
      </div>

      <div class="card">
        <h2>Kenapa checklist ini ampuh</h2>
        <div class="list">
          <div class="item">
            <div class="item-title">Biar kerja ‚Äúlebih mudah‚Äù dari distraksi</div>
            <div class="item-sub">Kamu menang bukan karena kuat, tapi karena environment kamu bener.</div>
          </div>
          <div class="item">
            <div class="item-title">Biar mulai itu murah</div>
            <div class="item-sub">Otak benci memulai. Checklist bikin memulai jadi otomatis.</div>
          </div>
          <div class="item">
            <div class="item-title">Biar kamu nggak debat sama diri sendiri</div>
            <div class="item-sub">Keputusan udah dibuat dari awal: ‚Äúhabis checklist ‚Üí fokus‚Äù.</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- STATS -->
  <section class="section" id="stats">
    <div class="grid">
      <div class="card">
        <h2>Statistik (7 hari terakhir)</h2>
        <div class="muted">Biar kamu lihat progres nyata, bukan perasaan.</div>
        <div class="bars" id="bar7"></div>

        <div class="hr"></div>
        <h2>Log terakhir</h2>
        <div class="list" id="logList"></div>
      </div>

      <div class="card">
        <h2>Streak</h2>
        <div class="kpi">
          <div class="pill"><span>Current</span> <span class="num" id="stCurrent">0</span></div>
          <div class="pill"><span>Best</span> <span class="num" id="stBest">0</span></div>
          <div class="pill"><span>Hari aktif 7d</span> <span class="num" id="stActive7">0</span></div>
        </div>

        <div class="hr"></div>

        <h2>Ekspor / Impor data</h2>
        <div class="muted">Kalau kamu pindah device atau mau backup.</div>
        <div class="btnrow">
          <button class="btn" id="btnExport">Export JSON</button>
          <button class="btn" id="btnImport">Import JSON</button>
          <button class="btn danger" id="btnWipe">Wipe semua data</button>
        </div>
        <div class="field">
          <label>Paste JSON untuk import (opsional)</label>
          <textarea id="importBox" placeholder="Tempel JSON di sini lalu klik Import JSON"></textarea>
        </div>
      </div>
    </div>
  </section>

  <!-- SETTINGS -->
  <section class="section" id="settings">
    <div class="grid">
      <div class="card">
        <h2>Settings</h2>

        <div class="field">
          <label>Durasi fokus (menit)</label>
          <select id="sFocus">
            <option value="15">15</option>
            <option value="20">20</option>
            <option value="25" selected>25</option>
            <option value="30">30</option>
            <option value="45">45</option>
          </select>
        </div>

        <div class="field">
          <label>Durasi break (menit)</label>
          <select id="sBreak">
            <option value="3">3</option>
            <option value="5" selected>5</option>
            <option value="8">8</option>
            <option value="10">10</option>
          </select>
        </div>

        <div class="field">
          <label>Target fokus harian (jumlah sesi)</label>
          <select id="sGoal">
            <option value="1">1</option>
            <option value="2" selected>2</option>
            <option value="3">3</option>
            <option value="4">4</option>
          </select>
        </div>

        <div class="btnrow">
          <button class="btn primary" id="sSave">Simpan settings</button>
          <button class="btn" id="sDefaults">Reset ke default</button>
        </div>

        <div class="hr"></div>

        <h2>Shortcut</h2>
        <div class="muted">Di PC: <span class="kbd">S</span> starter ‚Ä¢ <span class="kbd">F</span> fokus ‚Ä¢ <span class="kbd">B</span> break ‚Ä¢ <span class="kbd">Esc</span> stop modal</div>
      </div>

      <div class="card">
        <h2>Ritual harian 60 detik (paling efektif)</h2>
        <div class="list">
          <div class="item">
            <div class="item-title">1) Pilih 1 target hari ini</div>
            <div class="item-sub">Bukan 10 target. Cuma 1 yang paling ngaruh.</div>
          </div>
          <div class="item">
            <div class="item-title">2) Tulis langkah kecil yang valid</div>
            <div class="item-sub">Harus bisa dilakukan sekarang, 1‚Äì3 menit.</div>
          </div>
          <div class="item">
            <div class="item-title">3) Starter 2 menit ‚Üí lanjut 15/25 menit</div>
            <div class="item-sub">Tanpa negosiasi. Hadir dulu.</div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<footer>
  <div class="foot-inner">
    <div class="tiny" id="footStatus">Idle ‚Ä¢ Data tersimpan lokal</div>
    <div class="tiny">Sesi selesai = streak naik. Minimal 1 sesi/hari.</div>
  </div>
</footer>

<div class="modalBack" id="modalBack" role="dialog" aria-modal="true">
  <div class="modal" id="modal">
    <h3 id="mTitle">Modal</h3>
    <p id="mBody">‚Äî</p>
    <div class="btnrow" id="mBtns"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* =============================
   FokusKecil ‚Äî vanilla JS, offline
   ============================= */

const LS_KEY = "fokuskecil_v1";

const dayNames = ["Min","Sen","Sel","Rab","Kam","Jum","Sab"];
const pad2 = n => String(n).padStart(2,"0");
const now = () => new Date();
const todayKey = (d=new Date()) => d.toISOString().slice(0,10);

function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

function loadState(){
  const raw = localStorage.getItem(LS_KEY);
  if(!raw){
    return {
      settings: { focusMin: 25, breakMin: 5, dailyGoal: 2 },
      tasks: [],
      plans: [],
      logs: [],
      streak: { current: 0, best: 0, lastActive: null },
      timer: { running:false, mode:"idle", endTime:null, durationSec:0, startedAt:null, target:"", meta:{} },
      setup: {
        checks: [
          {id:"c1", text:"Aktifkan DND / matikan notifikasi", done:false},
          {id:"c2", text:"Taruh HP jauh (atau flight mode)", done:false},
          {id:"c3", text:"Bersihin meja 1 menit", done:false},
          {id:"c4", text:"Tutup tab/aplikasi yang nggak relevan", done:false},
          {id:"c5", text:"Tulis target langkah kecil sesi ini", done:false},
        ]
      },
      mit: { text:"" }
    };
  }
  try{
    const s = JSON.parse(raw);
    // minimal migration safety:
    s.settings ||= { focusMin:25, breakMin:5, dailyGoal:2 };
    s.tasks ||= [];
    s.plans ||= [];
    s.logs ||= [];
    s.streak ||= { current:0, best:0, lastActive:null };
    s.timer ||= { running:false, mode:"idle", endTime:null, durationSec:0, startedAt:null, target:"", meta:{} };
    s.setup ||= { checks: [] };
    if(!Array.isArray(s.setup.checks) || s.setup.checks.length===0){
      s.setup.checks = [
        {id:"c1", text:"Aktifkan DND / matikan notifikasi", done:false},
        {id:"c2", text:"Taruh HP jauh (atau flight mode)", done:false},
        {id:"c3", text:"Bersihin meja 1 menit", done:false},
        {id:"c4", text:"Tutup tab/aplikasi yang nggak relevan", done:false},
        {id:"c5", text:"Tulis target langkah kecil sesi ini", done:false},
      ];
    }
    s.mit ||= { text:"" };
    return s;
  }catch(e){
    localStorage.removeItem(LS_KEY);
    return loadState();
  }
}

function saveState(){
  localStorage.setItem(LS_KEY, JSON.stringify(state));
}

let state = loadState();

/* ======= UI helpers ======= */
const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

function toast(msg){
  const t = $("#toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 2200);
}

function openModal(title, body, buttons){
  $("#mTitle").textContent = title;
  $("#mBody").textContent = body;
  const box = $("#mBtns");
  box.innerHTML = "";
  (buttons||[]).forEach(b=>{
    const btn = document.createElement("button");
    btn.className = "btn " + (b.kind||"");
    btn.textContent = b.text;
    btn.onclick = () => { if(b.onClick) b.onClick(); closeModal(); };
    box.appendChild(btn);
  });
  $("#modalBack").classList.add("show");
}
function closeModal(){
  $("#modalBack").classList.remove("show");
}
$("#modalBack").addEventListener("click", (e)=>{
  if(e.target.id==="modalBack") closeModal();
});
document.addEventListener("keydown",(e)=>{
  if(e.key==="Escape") closeModal();
});

/* ======= Navigation ======= */
$$(".tab").forEach(tab=>{
  tab.addEventListener("click", ()=>{
    $$(".tab").forEach(t=>t.classList.remove("active"));
    tab.classList.add("active");
    const id = tab.dataset.section;
    $$(".section").forEach(s=>s.classList.remove("active"));
    $("#"+id).classList.add("active");
    renderAll();
  });
});

/* ======= Stats & streak ======= */
function isSameDay(a,b){
  return todayKey(a) === todayKey(b);
}
function minutesToday(){
  const t = todayKey();
  return state.logs
    .filter(x=>x.type==="focus" && (x.day===t))
    .reduce((sum,x)=>sum + (x.minutes||0), 0);
}
function sessionsToday(){
  const t = todayKey();
  return state.logs.filter(x=>x.type==="focus" && x.day===t).length;
}
function minutesLast7(){
  const days = lastNDays(7);
  const set = new Set(days);
  return state.logs
    .filter(x=>x.type==="focus" && set.has(x.day))
    .reduce((sum,x)=>sum + (x.minutes||0), 0);
}
function activeDaysLast7(){
  const days = lastNDays(7);
  const map = new Map(days.map(d=>[d,0]));
  state.logs.filter(x=>x.type==="focus").forEach(x=>{
    if(map.has(x.day)) map.set(x.day, map.get(x.day)+ (x.minutes||0));
  });
  return Array.from(map.values()).filter(v=>v>0).length;
}
function lastNDays(n){
  const out = [];
  const d = new Date();
  d.setHours(12,0,0,0);
  for(let i=n-1;i>=0;i--){
    const x = new Date(d);
    x.setDate(d.getDate()-i);
    out.push(todayKey(x));
  }
  return out;
}
function updateStreakIfNeeded(){
  const t = todayKey();
  // Determine if today is active:
  const activeToday = sessionsToday() > 0;
  if(!activeToday) return;

  const last = state.streak.lastActive;
  if(last === t) return; // already counted
  // If lastActive is yesterday -> streak++ else reset to 1
  if(last){
    const lastDate = new Date(last+"T12:00:00");
    const y = new Date(t+"T12:00:00");
    const diffDays = Math.round((y - lastDate) / (1000*60*60*24));
    if(diffDays === 1){
      state.streak.current += 1;
    }else{
      state.streak.current = 1;
    }
  }else{
    state.streak.current = 1;
  }
  state.streak.lastActive = t;
  state.streak.best = Math.max(state.streak.best, state.streak.current);
  saveState();
}

/* ======= Timer ======= */
let ticker = null;

function setFoot(msg){
  $("#footStatus").textContent = msg;
}

function formatTime(sec){
  const m = Math.floor(sec/60);
  const s = sec%60;
  return `${pad2(m)}:${pad2(s)}`;
}

function beep(){
  try{
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type="sine";
    o.frequency.value = 880;
    g.gain.value = 0.04;
    o.connect(g); g.connect(ctx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); ctx.close(); }, 220);
  }catch(e){
    // ignore
  }
}

function startTimer(mode, minutes, target, meta={}){
  const dur = Math.max(1, Math.round(minutes*60));
  const end = Date.now() + dur*1000;
  state.timer = {
    running: true,
    mode,
    endTime: end,
    durationSec: dur,
    startedAt: Date.now(),
    target: (target||"").trim(),
    meta
  };
  saveState();
  runTicker();
  renderTimer();
  setFoot(`Running ‚Ä¢ ${mode} ‚Ä¢ target: ${state.timer.target || "‚Äî"}`);
  toast(mode==="starter" ? "Starter 2 menit dimulai" : mode==="focus" ? "Sesi fokus dimulai" : "Break dimulai");
}

function stopTimer(silent=false){
  state.timer.running = false;
  state.timer.mode = "idle";
  state.timer.endTime = null;
  state.timer.durationSec = 0;
  state.timer.startedAt = null;
  saveState();
  if(ticker){ clearInterval(ticker); ticker=null; }
  renderTimer();
  setFoot("Idle ‚Ä¢ Data tersimpan lokal");
  if(!silent) toast("Timer dihentikan");
}

function finishTimer(){
  const mode = state.timer.mode;
  const durMin = Math.round(state.timer.durationSec/60);
  const target = state.timer.target;

  if(mode==="focus"){
    const entry = {
      id: uid(),
      type: "focus",
      minutes: durMin,
      target,
      day: todayKey(),
      startedAt: state.timer.startedAt,
      finishedAt: Date.now()
    };
    state.logs.unshift(entry);
    // keep logs reasonable
    if(state.logs.length > 250) state.logs.pop();
    saveState();
    updateStreakIfNeeded();
    beep();

    openModal(
      "Sesi fokus selesai ‚úÖ",
      `Bagus. Kamu menang karena hadir. Target: ${target || "‚Äî"}`,
      [
        {text:`Break ${state.settings.breakMin} menit`, kind:"ok", onClick:()=> startTimer("break", state.settings.breakMin, "Istirahat") },
        {text:`Lanjut fokus ${state.settings.focusMin} menit`, kind:"primary", onClick:()=> startTimer("focus", state.settings.focusMin, nextTargetSuggestion()) },
        {text:"Selesai dulu", onClick:()=>{}}
      ]
    );
  }else if(mode==="starter"){
    const entry = {
      id: uid(),
      type: "starter",
      minutes: durMin,
      target,
      day: todayKey(),
      startedAt: state.timer.startedAt,
      finishedAt: Date.now()
    };
    state.logs.unshift(entry);
    if(state.logs.length > 250) state.logs.pop();
    saveState();
    beep();

    openModal(
      "Starter selesai üî•",
      `Sekarang pilih: lanjut 10 menit atau masuk Pomodoro. Target: ${target || "‚Äî"}`,
      [
        {text:"Lanjut 10 menit", kind:"ok", onClick:()=> startTimer("focus", 10, target || nextTargetSuggestion(), {fromStarter:true}) },
        {text:`Pomodoro ${state.settings.focusMin} menit`, kind:"primary", onClick:()=> startTimer("focus", state.settings.focusMin, target || nextTargetSuggestion(), {fromStarter:true}) },
        {text:"Stop", kind:"danger", onClick:()=> stopTimer(true)}
      ]
    );
  }else if(mode==="break"){
    beep();
    openModal(
      "Break selesai",
      "Balik ke fokus. Jangan cek hal yang bikin kamu nyangkut.",
      [
        {text:`Mulai fokus ${state.settings.focusMin} menit`, kind:"primary", onClick:()=> startTimer("focus", state.settings.focusMin, nextTargetSuggestion())},
        {text:"Nanti dulu", onClick:()=>{}}
      ]
    );
  }

  stopTimer(true);
  renderAll();
}

function runTicker(){
  if(ticker) clearInterval(ticker);
  ticker = setInterval(()=>{
    if(!state.timer.running || !state.timer.endTime) return;
    const remain = Math.max(0, Math.round((state.timer.endTime - Date.now())/1000));
    renderTimer(remain);
    if(remain<=0){
      clearInterval(ticker); ticker=null;
      finishTimer();
    }
  }, 250);
}

function renderTimer(remainOverride=null){
  const t = state.timer;
  let remain = 0;

  if(t.running && t.endTime){
    remain = Math.max(0, Math.round((t.endTime - Date.now())/1000));
  }
  if(remainOverride!==null) remain = remainOverride;

  $("#time").textContent = t.running ? formatTime(remain) : "00:00";
  $("#modeLabel").textContent = t.running ? (t.mode==="focus" ? "Fokus" : t.mode==="starter" ? "Starter" : "Break") : "Idle";
  $("#modeDesc").textContent = t.running ? (t.target || "‚Äî") : "‚Äî";
  $("#timerHint").textContent = t.running
    ? (t.mode==="starter" ? "Tujuan: memulai. Nggak perlu sempurna." :
       t.mode==="focus" ? "Hadir sampai timer habis. Jangan negosiasi." :
       "Istirahat beneran. Jangan scroll yang bikin nyangkut.")
    : "Timer siap. Pilih ‚Äú2 menit‚Äù atau ‚ÄúFokus‚Äù.";
}

/* ======= Tasks ======= */
function addTask(title, tiny, note=""){
  const t = (title||"").trim();
  const s = (tiny||"").trim();
  if(!t || !s){ toast("Judul & langkah kecil wajib diisi"); return; }
  state.tasks.unshift({
    id: uid(),
    title: t,
    tinyStep: s,
    note: (note||"").trim(),
    status: "todo",
    createdAt: Date.now(),
    doneAt: null
  });
  saveState();
  toast("Tugas ditambahkan");
  renderAll();
}

function toggleTaskDone(id){
  const x = state.tasks.find(t=>t.id===id);
  if(!x) return;
  x.status = (x.status==="done") ? "todo" : "done";
  x.doneAt = (x.status==="done") ? Date.now() : null;
  saveState();
  renderAll();
}
function deleteTask(id){
  state.tasks = state.tasks.filter(t=>t.id!==id);
  saveState(); renderAll();
}
function clearDoneTasks(){
  const before = state.tasks.length;
  state.tasks = state.tasks.filter(t=>t.status!=="done");
  saveState();
  toast(`Hapus ${before - state.tasks.length} tugas selesai`);
  renderAll();
}

function pickTask(id){
  const x = state.tasks.find(t=>t.id===id);
  if(!x) return;
  $("#sessionTarget").value = x.tinyStep || x.title;
  toast("Target sesi diisi dari langkah kecil tugas");
}

/* ======= Plans ======= */
function addPlan(pIf, pThen){
  const a = (pIf||"").trim();
  const b = (pThen||"").trim();
  if(!a || !b){ toast("Trigger & aksi wajib diisi"); return; }
  state.plans.unshift({ id: uid(), if: a, then: b, createdAt: Date.now() });
  saveState(); toast("Plan ditambahkan"); renderAll();
}
function deletePlan(id){
  state.plans = state.plans.filter(p=>p.id!==id);
  saveState(); renderAll();
}
function seedPlans(){
  const seeds = [
    {if:"Kalau terasa malas mulai", then:"jalankan Starter 2 menit (tanpa nego)"},
    {if:"Kalau buka YouTube/IG", then:"kerja 25 menit dulu baru boleh buka"},
    {if:"Kalau habis mandi", then:"duduk 10 menit ngerjain outline/step kecil"},
    {if:"Kalau stuck", then:"tulis langkah kecil yang valid + mulai 2 menit"},
  ];
  // only add those not already present
  seeds.forEach(s=>{
    if(!state.plans.some(p=>p.if===s.if && p.then===s.then)){
      state.plans.push({ id: uid(), if:s.if, then:s.then, createdAt: Date.now() });
    }
  });
  state.plans.sort((a,b)=>b.createdAt-a.createdAt);
  saveState(); toast("Contoh plan ditambahkan"); renderAll();
}

/* ======= Setup checklist ======= */
function renderSetup(){
  const root = $("#setupList");
  root.innerHTML = "";
  state.setup.checks.forEach(c=>{
    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <div class="item-top">
        <div>
          <div class="item-title">${c.text}</div>
          <div class="item-sub">${c.done ? "Sudah" : "Belum"}</div>
        </div>
        <div class="item-actions">
          <button class="btn small ${c.done ? "" : "ok"}" data-id="${c.id}">${c.done ? "Undo" : "Done"}</button>
        </div>
      </div>
    `;
    root.appendChild(el);
    $("button", el).onclick = ()=>{
      const x = state.setup.checks.find(z=>z.id===c.id);
      x.done = !x.done;
      saveState(); renderSetup();
    };
  });
}

function resetSetup(){
  state.setup.checks.forEach(c=>c.done=false);
  saveState(); renderSetup(); toast("Checklist direset");
}

/* ======= Logs & bars ======= */
function renderBars(){
  const root = $("#bar7");
  root.innerHTML = "";
  const days = lastNDays(7);
  const map = new Map(days.map(d=>[d,0]));
  state.logs.filter(x=>x.type==="focus").forEach(x=>{
    if(map.has(x.day)) map.set(x.day, map.get(x.day) + (x.minutes||0));
  });
  const max = Math.max(30, ...Array.from(map.values())); // to avoid too small bars
  days.forEach(d=>{
    const date = new Date(d+"T12:00:00");
    const label = dayNames[date.getDay()] + " " + d.slice(5);
    const v = map.get(d);
    const pct = Math.min(100, Math.round((v/max)*100));
    const row = document.createElement("div");
    row.className = "barRow";
    row.innerHTML = `
      <div class="day">${label}</div>
      <div class="bar"><i style="width:${pct}%"></i></div>
      <div class="min">${v}m</div>
    `;
    root.appendChild(row);
  });
}

function renderLogs(){
  const root = $("#logList");
  root.innerHTML = "";
  const slice = state.logs.slice(0,10);
  if(slice.length===0){
    root.innerHTML = `<div class="item"><div class="item-title">Belum ada log</div><div class="item-sub">Mulai dengan Starter 2 menit.</div></div>`;
    return;
  }
  slice.forEach(l=>{
    const time = new Date(l.finishedAt || l.startedAt).toLocaleString();
    const badge = l.type==="focus" ? "ok" : "warn";
    const label = l.type==="focus" ? "Fokus" : "Starter";
    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <div class="item-top">
        <div>
          <div class="item-title">${label} ‚Ä¢ ${l.minutes} menit</div>
          <div class="item-sub">${time}</div>
          <div class="item-sub">Target: ${l.target ? l.target : "‚Äî"}</div>
        </div>
        <div class="item-actions">
          <span class="badge ${badge}">${l.day}</span>
        </div>
      </div>
    `;
    root.appendChild(el);
  });
}

/* ======= Render tasks & plans ======= */
function renderTasks(){
  const root = $("#taskList");
  root.innerHTML = "";
  if(state.tasks.length===0){
    root.innerHTML = `<div class="item"><div class="item-title">Belum ada tugas</div><div class="item-sub">Tambah 1 tugas + langkah kecilnya. Itu kunci anti procrastination.</div></div>`;
    return;
  }
  state.tasks.forEach(t=>{
    const el = document.createElement("div");
    el.className = "item";
    const done = t.status==="done";
    el.innerHTML = `
      <div class="item-top">
        <div style="min-width:0">
          <div class="item-title">${done ? "‚úÖ " : ""}${escapeHtml(t.title)}</div>
          <div class="item-sub">Langkah kecil: ${escapeHtml(t.tinyStep)}</div>
          ${t.note ? `<div class="item-sub">Catatan: ${escapeHtml(t.note)}</div>` : ""}
        </div>
        <div class="item-actions">
          <button class="btn small ${done ? "" : "ok"}" data-act="done">${done ? "Undo" : "Selesai"}</button>
          <button class="btn small primary" data-act="pick">Pakai target</button>
          <button class="btn small danger" data-act="del">Hapus</button>
        </div>
      </div>
    `;
    const btns = $$("button", el);
    btns.find(b=>b.dataset.act==="done").onclick = ()=>toggleTaskDone(t.id);
    btns.find(b=>b.dataset.act==="pick").onclick = ()=>pickTask(t.id);
    btns.find(b=>b.dataset.act==="del").onclick = ()=>deleteTask(t.id);
    root.appendChild(el);
  });
}

function renderPlans(){
  const root = $("#planList");
  root.innerHTML = "";
  if(state.plans.length===0){
    root.innerHTML = `<div class="item"><div class="item-title">Belum ada plan</div><div class="item-sub">Bikin 1 plan paling penting: ‚ÄúKalau malas mulai ‚Üí Starter 2 menit‚Äù.</div></div>`;
    return;
  }
  state.plans.forEach(p=>{
    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <div class="item-top">
        <div style="min-width:0">
          <div class="item-title">Kalau: ${escapeHtml(p.if)}</div>
          <div class="item-sub">Maka: ${escapeHtml(p.then)}</div>
        </div>
        <div class="item-actions">
          <button class="btn small danger">Hapus</button>
        </div>
      </div>
    `;
    $("button", el).onclick = ()=>deletePlan(p.id);
    root.appendChild(el);
  });
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, (m)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

/* ======= Suggestions ======= */
function nextTargetSuggestion(){
  const mit = (state.mit?.text || "").trim();
  if(mit) return mit;
  const firstTodo = state.tasks.find(t=>t.status==="todo");
  if(firstTodo) return firstTodo.tinyStep || firstTodo.title;
  return ($("#sessionTarget").value || "").trim();
}

/* ======= Dashboard controls ======= */
$("#btnStarter").onclick = ()=>{
  const target = $("#sessionTarget").value.trim() || nextTargetSuggestion() || "Mulai apa pun yang paling kecil";
  startTimer("starter", 2, target);
};
$("#btnFocus").onclick = ()=>{
  const target = $("#sessionTarget").value.trim() || nextTargetSuggestion() || "Langkah kecil yang valid";
  startTimer("focus", state.settings.focusMin, target);
};
$("#btnBreak").onclick = ()=>{
  startTimer("break", state.settings.breakMin, "Istirahat");
};
$("#btnStop").onclick = ()=> stopTimer();

$("#btnEmergency").onclick = ()=>{
  openModal(
    "Reset 5 menit",
    "Urutan: minum air ‚Üí 10 napas ‚Üí rapihin meja 1 menit ‚Üí tulis langkah kecil ‚Üí starter 2 menit.",
    [
      {text:"Minum air (done)", kind:"ok", onClick:()=>toast("Bagus. Lanjut 10 napas.")},
      {text:"Lanjut", kind:"primary", onClick:()=>{
        $("#sessionTarget").value = $("#sessionTarget").value.trim() || "Tulis 3 bullet outline";
        startTimer("starter", 2, $("#sessionTarget").value.trim());
      }},
      {text:"Tutup", onClick:()=>{}}
    ]
  );
};

$("#btnQuickMIT").onclick = ()=>{
  openModal(
    "Set 1 target hari ini",
    "Tulis 1 hal paling penting. Bukan 10 hal.",
    [
      {text:"Isi dari tugas pertama", kind:"primary", onClick:()=>{
        const firstTodo = state.tasks.find(t=>t.status==="todo");
        state.mit.text = firstTodo ? (firstTodo.tinyStep || firstTodo.title) : "";
        saveState(); $("#sessionTarget").value = state.mit.text || "";
        toast("MIT di-set");
      }},
      {text:"Saya ketik manual", kind:"ok", onClick:()=>{
        const v = prompt("Tulis 1 target paling penting hari ini:", state.mit.text || "");
        if(v!==null){ state.mit.text = v.trim(); saveState(); $("#sessionTarget").value = state.mit.text; toast("MIT disimpan"); }
      }},
      {text:"Batal", onClick:()=>{}}
    ]
  );
};

/* ======= Quick add ======= */
$("#btnAddTask").onclick = ()=>{
  addTask($("#qaTitle").value, $("#qaTiny").value, "");
  $("#qaTitle").value=""; $("#qaTiny").value="";
};

/* ======= Tasks page ======= */
$("#tAdd").onclick = ()=>{
  addTask($("#tTitle").value, $("#tTiny").value, $("#tNote").value);
  $("#tTitle").value=""; $("#tTiny").value=""; $("#tNote").value="";
};
$("#tClearDone").onclick = clearDoneTasks;

/* ======= Plans page ======= */
$("#pAdd").onclick = ()=>{
  addPlan($("#pIf").value, $("#pThen").value);
  $("#pIf").value=""; $("#pThen").value="";
};
$("#pSeed").onclick = seedPlans;
$("#btnDoContract").onclick = ()=>{
  toast("Kontrak diterima. Jangan nego.");
  // mark setup items a bit to encourage:
  state.setup.checks.forEach(c=>{
    if(["c1","c2","c4"].includes(c.id)) c.done=true;
  });
  saveState();
  $("#sessionTarget").focus();
};

/* ======= Setup page ======= */
$("#btnSetupReset").onclick = resetSetup;
$("#btnSetupDone").onclick = ()=>{
  const allDone = state.setup.checks.every(c=>c.done);
  if(!allDone){
    openModal(
      "Checklist belum lengkap",
      "Kamu boleh lanjut, tapi kualitas fokus biasanya turun kalau checklist di-skip.",
      [
        {text:"Balik checklist", kind:"ok", onClick:()=>{}},
        {text:`Mulai fokus ${state.settings.focusMin} menit`, kind:"primary", onClick:()=> startTimer("focus", state.settings.focusMin, $("#sessionTarget").value.trim() || nextTargetSuggestion())}
      ]
    );
    return;
  }
  startTimer("focus", state.settings.focusMin, $("#sessionTarget").value.trim() || nextTargetSuggestion());
};

/* ======= Stats page ======= */
$("#btnExport").onclick = ()=>{
  const data = JSON.stringify(state, null, 2);
  navigator.clipboard?.writeText(data).then(()=>toast("JSON dicopy ke clipboard")).catch(()=>{});
  openModal("Export JSON", "Data sudah dicopy ke clipboard. Kamu juga bisa copy dari box import di bawah.", [
    {text:"Tutup", onClick:()=>{}}
  ]);
  $("#importBox").value = data;
};
$("#btnImport").onclick = ()=>{
  const raw = $("#importBox").value.trim();
  if(!raw){ toast("Tempel JSON dulu"); return; }
  try{
    const parsed = JSON.parse(raw);
    // basic guard
    if(!parsed || typeof parsed !== "object") throw new Error("Invalid");
    state = parsed;
    saveState();
    toast("Import berhasil");
    renderAll();
  }catch(e){
    toast("JSON tidak valid");
  }
};
$("#btnWipe").onclick = ()=>{
  openModal(
    "Wipe data?",
    "Ini akan menghapus semua tugas, plan, log, streak. Tidak bisa dibatalkan.",
    [
      {text:"Hapus", kind:"danger", onClick:()=>{
        localStorage.removeItem(LS_KEY);
        state = loadState();
        saveState();
        renderAll();
        toast("Data dihapus");
      }},
      {text:"Batal", onClick:()=>{}}
    ]
  );
};

/* ======= Settings page ======= */
function renderSettings(){
  $("#sFocus").value = String(state.settings.focusMin);
  $("#sBreak").value = String(state.settings.breakMin);
  $("#sGoal").value = String(state.settings.dailyGoal);
}
$("#sSave").onclick = ()=>{
  state.settings.focusMin = parseInt($("#sFocus").value,10);
  state.settings.breakMin = parseInt($("#sBreak").value,10);
  state.settings.dailyGoal = parseInt($("#sGoal").value,10);
  saveState();
  toast("Settings disimpan");
  renderAll();
};
$("#sDefaults").onclick = ()=>{
  state.settings = { focusMin:25, breakMin:5, dailyGoal:2 };
  saveState(); toast("Reset ke default"); renderAll();
};

/* ======= Keyboard shortcuts ======= */
document.addEventListener("keydown",(e)=>{
  if(e.target && ["INPUT","TEXTAREA","SELECT"].includes(e.target.tagName)) return;
  const k = e.key.toLowerCase();
  if(k==="s") $("#btnStarter").click();
  if(k==="f") $("#btnFocus").click();
  if(k==="b") $("#btnBreak").click();
});

/* ======= Restore timer after refresh ======= */
function restoreTimer(){
  if(state.timer && state.timer.running && state.timer.endTime){
    const remain = Math.max(0, Math.round((state.timer.endTime - Date.now())/1000));
    if(remain<=0){
      // finish gracefully
      finishTimer();
    }else{
      runTicker();
      renderTimer(remain);
      setFoot(`Running ‚Ä¢ ${state.timer.mode} ‚Ä¢ target: ${state.timer.target || "‚Äî"}`);
    }
  }else{
    renderTimer();
  }
}

/* ======= Render all ======= */
function renderKpis(){
  $("#kpiStreak").textContent = String(state.streak.current || 0);
  $("#kpiToday").textContent = String(sessionsToday());
  $("#kpiGoal").textContent = String(state.settings.dailyGoal || 2);
  $("#kpi7d").textContent = String(minutesLast7());
}
function renderStreakStats(){
  $("#stCurrent").textContent = String(state.streak.current || 0);
  $("#stBest").textContent = String(state.streak.best || 0);
  $("#stActive7").textContent = String(activeDaysLast7());
}
function renderAll(){
  // update streak if new logs today
  updateStreakIfNeeded();
  renderKpis();
  renderTasks();
  renderPlans();
  renderSetup();
  renderBars();
  renderLogs();
  renderStreakStats();
  renderSettings();
}
renderAll();
restoreTimer();

/* ======= SW register ======= */
if("serviceWorker" in navigator){
  window.addEventListener("load", ()=>{
    navigator.serviceWorker.register("sw.js").catch(()=>{});
  });
}
</script>
</body>
</html>
